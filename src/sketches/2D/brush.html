<script src="./lib/vendor/p5.min.js" data-head></script>
<script src="./lib/components/range.js" data-head></script>
<script src="./lib/classes/ui.js" data-head></script>

<style>
  canvas {
    border: 4px solid;
  }
  input {
    display: block;
  }
  fieldset {
    display: flex;
    gap: 1rem;
    justify-content: space-between;
    align-items: center;
  }
</style>

<div id="controls">
  <fieldset class="sliders">
    <label for="opacity">Opacity
      <input id="opacity" is="my-range" value="0.5" />
    </label>
    <label for="strokeWidth">Stroke
      <input id="strokeWidth" is="my-range" value="0.5"/>
    </label>
    <label for="bleed">Bleed
      <input id="bleed" is="my-range" value="0.9"/>
    </label>
  </fieldset>
  <fieldset>
    <label for="stroke">Paint
      <input type="color" id="stroke" />
    </label>
    <label for="stroke">Background
      <input type="color" id="bg-color" />
    </label>
    <button type="button" id="clear">Clear</button>
  </fieldset>
</div>

<script>
  const ui = new UI().initialize({
    opacityInput: document.getElementById('opacity'),
    strokeWeightInput: document.getElementById('strokeWidth'),
    bleedInput: document.getElementById('bleed'),
    colorInput: document.getElementById('stroke'),
    backgroundInput: document.getElementById('bg-color'),
    clearButton: document.getElementById('clear')
  });
  ui.registerAction('opacityChange', ui.elements.opacityInput, 'input');
  ui.registerAction('strokeWeightChange', ui.elements.strokeWeightInput, 'input');
  ui.registerAction('bleedChange', ui.elements.bleedInput, 'input');
  ui.registerAction('colorChange', ui.elements.colorInput, 'input');
  ui.registerAction('backgroundColorChange', ui.elements.backgroundInput, 'input');
  ui.registerAction('clear', ui.elements.clearButton, 'click');
</script>

<script id="sketch">
let g, brush, bgColor;
function setup() {
  createCanvas(500, 500);
  ui.registerCanvas('.p5Canvas');
  strokeCap(PROJECT);
  g = createGraphics(width, height);
  bgColor = color(255);

  brush = new Brush(
    ui.elements.strokeWeightInput.value,
    ui.elements.colorInput.value,
    ui.elements.opacityInput.value
  );

  ui.on('opacityChange', (e) => brush.setOpacity(parseFloat(ui.elements.opacityInput.value)));
  ui.on('strokeWeightChange', (e) => brush.setBaseWeight(parseFloat(ui.elements.strokeWeightInput.value)));
  ui.on('colorChange', (e) => {
    console.log('color');
    brush.setColor(ui.elements.colorInput.value)
  });
  ui.on('backgroundColorChange', (e) => bgColor = color(e.target.value));
  ui.on('clear', (e) => {
    g.clear();
    clear();
  });
}

function draw() {
  const bleed = 255-(parseFloat(ui.elements.bleedInput.value) * 255);
  background(red(bgColor), green(bgColor), blue(bgColor), bleed);
  if (ui.mouseDown) brush.draw(g);
  filter(BLUR);
  image(g, 0, 0);
}

function mouseReleased() {
  brush.prevWeight = 0;
}

class Brush {
  constructor(w, c, o) {
    this.baseWeight = parseFloat(w);
    this.weight = parseFloat(w); 
    this.prevWeight = parseFloat(w);
    this.color = color(c);
    this.opacity = parseFloat(o)*255;
  }

  setBaseWeight(scale) {
    this.baseWeight = scale * 20;
  }

  setColor(value) {
    this.color = color(value);
  }

  setOpacity(value) {
    this.opacity = map(value, 0, 1, 2, 30);
  }

  draw(g) {
    let speed = dist(pmouseX, pmouseY, mouseX, mouseY);
    let segments = max(ceil(speed * 2), 1); 
    
    let targetWeight = map(speed, 0, 50, this.baseWeight, this.baseWeight+50);
    
    let smoothedWeight = lerp(this.prevWeight, targetWeight, 0.1);

    for (let i = 0; i < segments; i++) {
      let t1 = i / segments;
      let t2 = (i + 1) / segments;
      
      let x1 = lerp(pmouseX, mouseX, t1);
      let y1 = lerp(pmouseY, mouseY, t1);
      let x2 = lerp(pmouseX, mouseX, t2);
      let y2 = lerp(pmouseY, mouseY, t2);
      
      let segmentWeight = lerp(this.prevWeight, smoothedWeight, (t1 + t2) / 2);
      
      g.strokeWeight(segmentWeight);
      g.stroke(this.color.levels[0], this.color.levels[1], this.color.levels[2], this.opacity);
      g.line(x1, y1, x2, y2);
    }
    
    this.prevWeight = smoothedWeight;
  }
}
</script>
