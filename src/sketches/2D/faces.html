<title></title>

<script src="./lib/p5.min.js" data-head ></script>
<script src="./lib/face-api.min.js" data-head ></script>

<img id="img" src="./assets/people2.jpg" style="opacity: 0; position: absolute" />

<script id="sketch">
var imgjs;
var imghtml;
var detections;
var slider;
var boxPos;
var boxDim;
var nextBoxDim;
var nextBoxPos;
var boxes = [];
var randomIndex = 0;

function setup() {
  createCanvas(0, 0);
  boxDim = createVector(0, 0);
  boxPos = createVector(0, 0);
  nextBoxDim = createVector(0, 0);
  nextBoxPos = createVector(0, 0);
  imgjs = loadImage("./assets/people2.jpg");
  imghtml = document.getElementById("img");
  let bb = imghtml.getBoundingClientRect();
  resizeCanvas(bb.width, bb.height);
  textSize(32);
  fill(0);
  text('loading...', width/2, height/2);
  blendMode(LIGHTEST);
}

function draw() {
  let bb = imghtml.getBoundingClientRect();
  if (boxes.length > 0) {
    resizeCanvas(bb.width, bb.height);
    image(imgjs, 0, 0);
    //clearInterval(awaitDetection);
    for (var i = 0; i < boxes.length; i++) {
      let nextFaceIndex = (i+1)%(detections.length); 
      copy(
        imgjs,
        boxes[i].x,
        boxes[i].y,
        boxes[i].w,
        boxes[i].h,
        boxes[nextFaceIndex].x,
        boxes[nextFaceIndex].y,
        boxes[nextFaceIndex].w,
        boxes[nextFaceIndex].h
      );
    }
    for (var i = boxes.length-1; i > 0; i--) {
      let nextFaceIndex = (i-1)%(detections.length); 
      copy(
        imgjs,
        boxes[i].x,
        boxes[i].y,
        boxes[i].w,
        boxes[i].h,
        boxes[nextFaceIndex].x,
        boxes[nextFaceIndex].y,
        boxes[nextFaceIndex].w,
        boxes[nextFaceIndex].h
      );
    }
    copy(
      imgjs,
      boxes[randomIndex].x,
      boxes[randomIndex].y,
      boxes[randomIndex].w,
      boxes[randomIndex].h,
      boxes[boxes.length-1].x,
      boxes[boxes.length-1].y,
      boxes[boxes.length-1].w,
      boxes[boxes.length-1].h
    );
  }
}

Promise.all([faceapi.nets.ssdMobilenetv1.loadFromUri("../../lib/models")]).then(detect).catch(error => console.log(error));


async function detect() {
	detections = await faceapi.detectAllFaces(
		imghtml,
		new faceapi.SsdMobilenetv1Options({ minConfidence: 0.1 })
	);
	if (imgjs) {
		for (var i = 0; i < detections.length; i++) {
			boxPos.x = detections[i].box.x;
			boxPos.y = detections[i].box.y;
			boxDim.x = detections[i].box.width;
			boxDim.y = detections[i].box.height;
			nextBoxPos.x = detections[i].box.x;
			nextBoxPos.y = detections[i].box.y;
			nextBoxDim.x = detections[i].box.width;
			nextBoxDim.y = detections[i].box.height;
			boxes[i] = new Box(boxPos.x, boxPos.y, boxDim.x, boxDim.y);
		}
	}
    randomIndex = Math.floor(Math.random()*(boxes.length-1));

}


class Box {
	constructor(x, y, w, h) {
		this.x = x;
		this.y = y;
		this.w = w;
		this.h = h;
	}

	display() {
		fill(0);
		rect(this.x, this.y, this.w, this.h);
	}
}
</script>
