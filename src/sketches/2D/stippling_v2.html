<script src="./lib/vendor/p5.min.js" data-head ></script>

<style>
#img {
  scale: 0.5;
  translate: 0 -25%;
  top: 4px;
}
</style>

<img id="img" src="./assets/woman.jpg" style="position: absolute; z-index: -1;"/>	
<script id="sketch">
let img, texture, points, currentPos, pointSize, lastPoint, radius;
function preload() {
  img = loadImage("./assets/woman.jpg");
}

function setup() {
  img.resize(img.width/2, img.height/2);
  createCanvas(img.width, img.height);

  texture = createGraphics(width,height);
  texture.image(img, 0,0, width, height);
  texture.filter(GRAY);
  texture.filter(INVERT);

  points = createGraphics(width, height);

  pointSize = 2;
  radius = 2;

  blendMode(BLEND);

  lastPoint = { x: 0, y: 1 };
}

function draw() {
  const p = stipple(lastPoint);
  lastPoint = p;
  image(points, 0, 0);
  if (p.y > height) noLoop();
}

function stipple(lastP) {
  let r = radius;
  let p = lastP;
  for (let x = 0; x < width; x+=r) {
    let imgColor = brightness(img.get(x, lastP.y))/255;
    p.x = x;
    p.y = lastP.y;
    p.imgColor = imgColor;
    points.stroke(255);
    for(let j = 0; j < r; j++) { 
      points.point(p.x+j,p.y+j);
    }
    points.stroke(0);
    drawPoint(p);
  }
  p = lastP;
  p.y++
  return p;
}

function drawPoint(p) {
  let density = (radius - (radius * p.imgColor * 3))*5;
  for (let i = 0; i < density; i++) {
    let center = createVector(width/2,height/2);
    let rMag = random(radius);
    let rHeading = random(TWO_PI);
    let pos = createVector(1, 1);
    pos.setHeading(rHeading);
    pos.setMag(rMag);
    pos.add(createVector(p.x,p.y));
    let imgColor = brightness(img.get(pos.x, pos.y))/255;
    //if (imgColor < 0.5) {
    points.point(pos.x, pos.y); 
    //}
  }
}
</script>
